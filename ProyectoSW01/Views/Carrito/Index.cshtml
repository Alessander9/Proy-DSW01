@model IEnumerable<ProyectoSW01.Models.CarritoItemViewModel>
@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@using ProyectoSW01.Models
@{
    ViewData["Title"] = "Carrito de servicios";

    var vehiculoId = ViewBag.VehiculoId != null ? (int)ViewBag.VehiculoId : 0;
    var carritoId = ViewBag.CarritoId != null ? (int)ViewBag.CarritoId : 0;
 
    var serviciosCarrito = Model ?? Enumerable.Empty<CarritoItemViewModel>();
    var repuestosCarrito = ViewBag.RepuestosCarrito as IEnumerable<RepuestoCarritoItemViewModel>
                           ?? Enumerable.Empty<RepuestoCarritoItemViewModel>();

    var totalServicios = serviciosCarrito.Sum(x => x.Subtotal);
    var totalRepuestos = repuestosCarrito.Sum(x => x.Subtotal);
    var total = totalServicios + totalRepuestos;
}

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<div class="max-w-5xl mx-auto px-4 py-8">

    <!-- Encabezado -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <span class="material-icons text-blue-700">shopping_cart</span>
                Carrito de servicios y repuestos
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                Vehículo ID: <span class="font-semibold">@vehiculoId</span>
            </p>
        </div>

        <a asp-controller="Vehiculo"
           asp-action="ListarVehiculos"
           class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">
            <span class="material-icons text-sm mr-1">arrow_back</span>
            Volver a vehículos
        </a>
    </div>

    <!-- Tabla de SERVICIOS del carrito -->
    <div class="bg-white shadow rounded-xl overflow-x-auto mb-6">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-blue-700 text-white">
                <tr>
                    <th class="px-4 py-3 text-left font-semibold">Servicio</th>
                    <th class="px-4 py-3 text-left font-semibold">Cantidad</th>
                    <th class="px-4 py-3 text-left font-semibold">Precio</th>
                    <th class="px-4 py-3 text-left font-semibold">Subtotal</th>
                    <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                @if (serviciosCarrito.Any())
                {
                    foreach (var item in serviciosCarrito)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-semibold">@item.ServicioNombre</td>
                            <td class="px-4 py-3">@item.Cantidad</td>
                            <td class="px-4 py-3">@item.Precio.ToString("C")</td>
                            <td class="px-4 py-3">@item.Subtotal.ToString("C")</td>
                            <td class="px-4 py-3 text-right">
                                <form asp-action="EliminarItem" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="vehiculoId" value="@vehiculoId" />
                                    <input type="hidden" name="carDetId" value="@item.CarDetId" />
                                    <button type="submit"
                                            class="text-red-600 hover:text-red-800"
                                            title="Eliminar del carrito">
                                        <span class="material-icons text-base">delete</span>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            No hay servicios en el carrito para este vehículo.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Tabla de REPUESTOS del carrito -->
    <div class="bg-white shadow rounded-xl overflow-x-auto mb-6">
        <h2 class="px-4 pt-4 text-lg font-semibold text-gray-800 flex items-center gap-2">
            <span class="material-icons text-blue-400">build</span>
            Repuestos en el carrito
        </h2>
        <table class="min-w-full divide-y divide-gray-200 text-sm mt-2">
            <thead class="bg-blue-400 text-white">
                <tr>
                    <th class="px-4 py-3 text-left font-semibold">Repuesto</th>
                    <th class="px-4 py-3 text-left font-semibold">Cantidad</th>
                    <th class="px-4 py-3 text-left font-semibold">Precio</th>
                    <th class="px-4 py-3 text-left font-semibold">Subtotal</th>
                    <th class="px-4 py-3 text-right font-semibold">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                @if (repuestosCarrito.Any())
                {
                    foreach (var rep in repuestosCarrito)
                    {
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-semibold">@rep.RepuestoNombre</td>
                            <td class="px-4 py-3">@rep.Cantidad</td>
                            <td class="px-4 py-3">@rep.Precio.ToString("C")</td>
                            <td class="px-4 py-3">@rep.Subtotal.ToString("C")</td>
                            <td class="px-4 py-3 text-right">
                                <form asp-action="EliminarRepuesto" method="post" class="inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="vehiculoId" value="@vehiculoId" />
                                    <input type="hidden" name="carRepId" value="@rep.CarRepId" />
                                    <button type="submit"
                                            class="text-red-600 hover:text-red-800"
                                            title="Eliminar repuesto del carrito">
                                        <span class="material-icons text-base">delete</span>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            No hay repuestos en el carrito para este vehículo.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Resumen total -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-8">
        <p class="text-sm text-gray-600">
            Servicios: <span class="font-semibold">@totalServicios.ToString("C")</span> |
            Repuestos: <span class="font-semibold">@totalRepuestos.ToString("C")</span>
        </p>
        <p class="text-lg text-gray-700">
            Total actual: <span class="font-bold">@total.ToString("C")</span>
        </p>
    </div>

    <!-- Formulario: Agregar SERVICIO al carrito -->
    <div class="bg-white shadow rounded-xl p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">
            <span class="material-icons text-blue-700">add_circle</span>
            Agregar servicio al carrito
        </h2>

        <form asp-action="Agregar" method="post" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            @Html.AntiForgeryToken()
            <input type="hidden" name="vehiculoId" value="@vehiculoId" />

            <!-- Servicio -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span class="material-icons text-sm align-middle mr-1 text-blue-700">home_repair_service</span>
                    Servicio
                </label>

                <select name="servicioId"
                        class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">Seleccione un servicio</option>
                    @if (ViewBag.Servicios != null)
                    {
                        foreach (var op in (IEnumerable<SelectListItem>)ViewBag.Servicios)
                        {
                            <option value="@op.Value">@op.Text</option>
                        }
                    }
                </select>
            </div>

            <!-- Cantidad -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span class="material-icons text-sm align-middle mr-1 text-blue-700">format_list_numbered</span>
                    Cantidad
                </label>
                <input type="number" name="cantidad" min="1" value="1"
                       class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" />
            </div>

            <!-- Botón -->
            <div class="md:col-span-1">
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg shadow hover:bg-blue-800 text-sm w-full md:w-auto">
                    <span class="material-icons text-sm mr-1">add_shopping_cart</span>
                    Agregar servicio
                </button>
            </div>
        </form>
    </div>

    <!-- Formulario: Agregar REPUESTO al carrito -->
    <div class="bg-white shadow rounded-xl p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">
            <span class="material-icons text-blue-400">build_circle</span>
            Agregar repuesto al carrito
        </h2>

        <form asp-action="AgregarRepuesto" method="post" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            @Html.AntiForgeryToken()
            <input type="hidden" name="vehiculoId" value="@vehiculoId" />

            <!-- Repuesto -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span class="material-icons text-sm align-middle mr-1 text-blue-400">construction</span>
                    Repuesto
                </label>

                <select name="repuestoId"
                        class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-amber-500 focus:border-blue-400 text-sm">
                    <option value="">Seleccione un repuesto</option>
                    @if (ViewBag.Repuestos != null)
                    {
                        foreach (var op in (IEnumerable<SelectListItem>)ViewBag.Repuestos)
                        {
                            <option value="@op.Value">@op.Text</option>
                        }
                    }
                </select>
            </div>

            <!-- Cantidad -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span class="material-icons text-sm align-middle mr-1 text-blue-400">format_list_numbered</span>
                    Cantidad
                </label>
                <input type="number" name="cantidad" min="1" value="1"
                       class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 text-sm" />
            </div>

            <!-- Botón -->
            <div class="md:col-span-1">
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 bg-blue-400 text-white rounded-lg shadow hover:bg-blue-900 text-sm w-full md:w-auto">
                    <span class="material-icons text-sm mr-1">add_shopping_cart</span>
                    Agregar repuesto
                </button>
            </div>
        </form>
    </div>

    <!-- Formulario: Crear orden de trabajo -->
    <div class="bg-white shadow rounded-xl p-6">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-4">
            <span class="material-icons text-blue-700">assignment_turned_in</span>
            Crear orden de trabajo
        </h2>

        <form asp-action="CrearOrden" method="post" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            @Html.AntiForgeryToken()
            <input type="hidden" name="vehiculoId" value="@vehiculoId" />
            <input type="hidden" name="carritoId" value="@carritoId" />

            <!-- Mecánico (opcional) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    <span class="material-icons text-sm align-middle mr-1 text-blue-700">engineering</span>
                    Mecánico (opcional)
                </label>

                <select name="mecanicoId"
                        class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">Sin mecánico asignado</option>
                    @if (ViewBag.Mecanicos != null)
                    {
                        foreach (var op in (IEnumerable<SelectListItem>)ViewBag.Mecanicos)
                        {
                            <option value="@op.Value">@op.Text</option>
                        }
                    }
                </select>
            </div>

            <div class="md:col-span-2 flex justify-end">
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 text-sm"
                        @((!serviciosCarrito.Any() && !repuestosCarrito.Any()) ? "disabled" : null)>
                    <span class="material-icons text-sm mr-1">done_all</span>
                    Crear orden de trabajo
                </button>
            </div>
        </form>

        @if (!serviciosCarrito.Any() && !repuestosCarrito.Any())
        {
            <p class="mt-3 text-xs text-gray-500">
                * Debe haber al menos un servicio o un repuesto en el carrito para crear una orden.
            </p>
        }
    </div>

</div>
